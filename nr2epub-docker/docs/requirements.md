# 要求仕様

## 機能要件

### 1. 取得・抽出（実装済み）
- なろう作品ページから作品メタデータ（表題、著者、あらすじ、話数）を取得
- 連載作品は指定話数の抽出を行い、チャプター構造を保持
- キャッシュ機能（メモリ + ファイルベース）で重複取得を回避
- 条件付きリクエスト（ETag/If-Modified-Since）対応
- なろう更新情報チェック付き検証（episodeUpdateTime）

### 2. 変換（実装済み）
- なろうHTMLをEPUB3形式に変換
- AozoraEpub3互換の本文構造と正規化に基づいて処理
- 縦書きCSS（writing-mode: vertical-rl）生成
- 目次ページ（nav.xhtml）と論理目次（toc.ncx）生成
- 表紙ページ、表題ページ、本文、目次を出力
- 基本段落、ルビ、傍点の変換
- 画像の処理（sharp での最適化、リサイズ）
- 改ページ、字下げなど基本的な注記対応

### 3. 出力（実装済み）
- EPUB3の標準構造を生成
  - mimetype, META-INF/container.xml
  - content.opf（メタデータ、manifest、spine）
  - nav.xhtml, toc.ncx（目次情報）
  - OEBPS/xhtml/, css/, images/
- Kindle互換のマークアップとCSS
- 出力ファイル名のカスタマイズ（{author}\_{title}.epub等）
- base64エンコードなしのストリーム返却（メール添付対応）

### 4. 配送（実装済み）
- 生成したEPUBを指定メールアドレスへ送信
- SMTP認証（ユーザー/パスワード）対応
- TLS/STARTTLS対応
- ジョブベースの非同期処理（statusポーリング対応）
- 環境変数またはWeb UI経由でのSMTP設定可能

### 5. Web UI（実装済み）
- ブラウザからの作品URL入力とエピソード指定
- ダウンロード / メール送信の切替
- ジョブ進捗表示（リアルタイムポーリング）
- 設定の保存・復元（LocalStorage）
- エクスポート・インポート（JSON）
- SMTP詳細設定の折り畳み表示

## 非機能要件

### 再現性（実装済み）
- 同一入力に対して同一出力を生成（タイムスタンプ除く）

### 安定性
- 話単位での失敗時はログ記録しスキップして継続（実装済み）
- リトライ機能：将来対応予定
- フォールバック：キャッシュ取得失敗時はリモート取得へ自動切替（実装済み）

### 性能
- 連載1000話規模の変換：現状未検証
- キャッシュ活用により軽量リクエストで更新チェック（実装済み）

### ログ
- 変換警告（キャッシュヒット、キャッシュ失効、処理進捗）をコンソール出力（実装済み）
- 未対応注記はWARNレベルで出力（実装済み）

### 互換性
- EPUB3 Validation：未検証（将来作業）
- Kindle表示互換：基本的なCSS対応（実装済み）

## AozoraEpub3互換性

### 設定項目対応
- 出力先：ブラウザダウンロード / メール添付（固定）
- 縦書き：有効（固定）
- 画像方針：1枚1ページに固定（将来可変化予定）
- 空行除去：5行減らす、最大1行（固定）
- 自動縦中横：有効（固定）
- 行の高さ：1.8（CSS固定）
- 文字サイズ：100%（CSS固定）

### 未実装項目（将来対応）
- 差分更新（新エピソードのみ取得）
- 設定ファイル（INI形式）の読み込み
- CLI インターフェース
- 画像の余白除去、単ページ化の設定化
- 外字（GAIJI）対応
- コメント処理の詳細化
- リトライ機能

## セキュリティ

### 認証情報（実装済み）
- SMTP認証情報は環境変数で保持
- Web UI上でのSMTP設定上書き可能（テスト用）
- エクスポート設定時は認証情報をマスク

### ファイル処理（実装済み）
- ファイル名のサニタイズ（危険文字除去）
- 日本語文字の保持

## 互換注記の扱い
- 基本注記（ルビ、傍点、強調）のHTML変換（実装済み）
- 未対応注記：警告ログ出力、本文は簡略表現で出力（実装済み）
